{{- if .Values.blackboxExporter.enabled }}
{{- $bb := .Values.blackboxExporter -}}
{{- $svcHost := printf "%s.%s.svc:%d" $bb.service.name $bb.namespace $bb.service.port -}}
{{- $exporterAddr := (default $svcHost $bb.serviceAddress) -}}
---
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "blackbox-probes.fullname" . }}-test-exporter
  namespace: {{ $bb.namespace | quote }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded,hook-failed
spec:
  restartPolicy: Never
  containers:
    - name: curl
      image: curlimages/curl:8.8.0
      imagePullPolicy: IfNotPresent
      args:
        - /bin/sh
        - -c
        - >
          set -euo pipefail;
          echo "Checking exporter at http://{{ $exporterAddr }}";
          curl -sfS "http://{{ $exporterAddr }}/" >/dev/null && echo "Exporter up";
      resources:
        requests: { cpu: "5m", memory: "16Mi" }
        limits: { cpu: "100m", memory: "64Mi" }
{{- end }}
